# Session Log - December 13, 2025

## Session: 12:00 PM

### Changes Made:

**Files Modified:**
1. `backend/omr.py` - Added PDF-to-PNG conversion for OEMER processing
2. `backend/requirements.txt` - Added pdf2image dependency
3. `Dockerfile` - Added poppler-utils system package

**Specific Changes:**

#### backend/omr.py (lines 134-240)
- Added PDF-to-image conversion using pdf2image library
- OEMER only accepts image files (PNG, JPG), not PDFs
- Converts first page of PDF to PNG at 300 DPI before OEMER processing
- Saves temporary PNG file in output directory
- Passes PNG to OEMER CLI instead of PDF
- Cleans up temporary PNG file after processing
- Added error handling for missing pdf2image import

#### backend/requirements.txt
- Added `pdf2image==1.17.0` for PDF to image conversion

#### Dockerfile
- Added `poppler-utils` to system dependencies (required by pdf2image)

**Dependencies Added:**
- pdf2image==1.17.0 (Python package)
- poppler-utils (system package via apt-get)

### Testing Performed:

**Not yet deployed** - Changes pending commit and Render deployment

**Expected Test:**
1. Upload PDF via web interface
2. Backend converts PDF to PNG
3. OEMER processes PNG file
4. Returns MusicXML output

### Issues Encountered:

**Issue 1: OEMER API Misunderstanding (Resolved in previous session)**
- Problem: Used `oemer.ommr()` which doesn't exist
- Error: `module 'oemer' has no attribute 'ommr'`
- Resolution: Changed to use OEMER CLI via subprocess

**Issue 2: OEMER Doesn't Accept PDF Files**
- Problem: OEMER only accepts image files, threw `PIL.UnidentifiedImageError`
- Error: `cannot identify image file '/app/uploads/716a2fb5-aa72-4cdf-9a56-e58acdef2b3c.pdf'`
- Resolution: Added PDF-to-PNG conversion step using pdf2image

### Next Steps:

1. Commit changes with message describing PDF-to-image conversion fix
2. Push to main branch to trigger Render deployment
3. Wait for deployment to complete
4. Test end-to-end: PDF upload → PNG conversion → OEMER processing → MusicXML output
5. Monitor logs for any errors
6. If successful, test with various sheet music PDFs
7. Optional: Implement Audiveris Google Cloud Run deployment per `ref/audiveris_cloud_run_plan.md`

### Blockers/Dependencies:

- None currently
- Waiting for deployment to test changes

---

## Session: 3:00 PM

### Changes Made:

**Files Modified:**
1. `backend/omr.py` - Increased timeout and added better logging/error handling

**Specific Changes:**

#### backend/omr.py
- **Increased default timeout from 300s (5 min) to 600s (10 min)** (line 111)
  - OEMER takes 3-5 minutes with GPU according to docs
  - Without GPU (Render free tier), it takes longer
  - Updated docstring to reflect new timeout and reasoning

- **Added comprehensive logging for OEMER process** (lines 205-227)
  - Log when process starts and completes
  - Log process return code
  - Log first 500 chars of stdout/stderr for debugging
  - Better timeout error handling with process cleanup

- **Improved MusicXML file detection** (lines 239-255)
  - Check for both `.musicxml` and `.xml` extensions
  - List all output files if expected file not found
  - Provide detailed error message showing what was expected vs what was generated

### Testing Performed:

**Not yet deployed** - Changes pending commit

**Expected Behavior:**
- OEMER should now have enough time to complete processing (10 min vs 5 min)
- Better logs will help diagnose if it's still timing out or failing for another reason
- If output file has different extension, we'll catch it now

### Issues Encountered:

**Issue 3: OEMER Process Timeout**
- Problem: OEMER was timing out during processing, never completing
- User error: "Load failed" with logs showing conversion to PNG succeeded but then infinite status polling
- Root Cause:
  - OEMER documentation states it takes 3-5 minutes with GPU
  - Render free tier likely doesn't have GPU, causing longer processing time
  - Default 5-minute timeout insufficient
- Resolution:
  - Increased timeout to 10 minutes
  - Added comprehensive logging to capture stdout/stderr
  - Improved error messages and file detection

### Research Findings:

**OEMER CLI Documentation:**
- Basic usage: `oemer <path_to_image> -o <output_dir>`
- Options: `-h`, `--help`, `-o/--output-path`, `--use-tf`, `--save-cache`, `-d/--without-deskew`
- Output: Creates MusicXML file and analysis image in output directory
- Performance: 3-5 min with GPU, 10+ min without GPU on first run (checkpoint downloads)
- Source: https://github.com/BreezeWhite/oemer

### Next Steps:

1. Commit timeout fix and improved logging
2. Push to trigger Render deployment
3. Test with PDF upload - monitor logs for OEMER stdout/stderr
4. If still timing out, may need to investigate OEMER checkpoint downloads
5. Consider adding `--save-cache` flag to speed up subsequent runs

### Blockers/Dependencies:

- None currently
- May hit timeout even with 10 minutes if checkpoints need to download
- May need to pre-download OEMER checkpoints in Dockerfile

---

## Session: 3:30 PM

### CRITICAL ISSUE: OEMER Memory Limit Exceeded

**Problem:**
Render Web Service exceeded its memory limit during OEMER processing, causing automatic restart.

**Error from Render:**
```
Web Service accordi exceeded its memory limit, which triggered an automatic restart.
```

**Root Cause:**
- OEMER is a deep learning OMR system that loads neural network models into memory
- Render free tier provides only 512 MB RAM
- OEMER's model checkpoints + inference require significantly more memory
- Process starts successfully (PDF → PNG conversion works), but crashes during OEMER model loading

**Evidence from Logs:**
```
INFO:omr:OEMER timeout set to 600 seconds
INFO:omr:OEMER process started, waiting for completion...
[multiple status polls]
[Instance exceeded memory limit - restart]
```

### Solutions Available

#### Option 1: Upgrade Render Instance (COSTS MONEY) ❌
- Render Starter plan: $7/month for 512 MB → 2 GB RAM
- Would likely solve OEMER memory issue
- **Downside:** Not free

#### Option 2: Deploy Audiveris on Google Cloud Run (FREE TIER) ✅ RECOMMENDED
- Use existing plan in `ref/audiveris_cloud_run_plan.md`
- Google Cloud Run free tier: 2 GB memory instances
- Deploy Audiveris as separate microservice
- Main backend calls Audiveris API via HTTP
- **Advantages:**
  - Stays within free tier limits
  - 2 GB memory sufficient for Audiveris
  - Separate scaling for OMR processing
  - Can remove OEMER from main backend entirely
- **Free tier limits:**
  - 2 million requests/month
  - 360,000 GB-seconds of memory
  - 180,000 vCPU-seconds
  - Estimated cost: $0-5/month

#### Option 3: Switch to Different OMR Solution ❌
- Research lighter-weight OMR alternatives
- Most OMR solutions use deep learning (memory intensive)
- Unlikely to find solution under 512 MB

#### Option 4: Pre-download OEMER Checkpoints (MIGHT NOT HELP)
- Download model checkpoints during Docker build
- Would eliminate first-run download time
- **BUT:** Still requires memory to load models during inference
- Unlikely to solve memory limit issue

### Recommendation

**Implement Option 2: Deploy Audiveris on Google Cloud Run**

**Justification:**
1. Comprehensive plan already exists
2. Stays within free tier
3. Better separation of concerns (OMR as microservice)
4. 2 GB memory on Cloud Run sufficient for Audiveris
5. Can remove OEMER entirely from main backend to reduce memory footprint

**Implementation Steps:**
1. Create `audiveris-service/` directory with plan files
2. Deploy to Google Cloud Run (15-20 min setup)
3. Update main backend to call Audiveris API
4. Remove OEMER from Dockerfile to free up memory
5. Test end-to-end with Cloud Run Audiveris

**Alternative if User Doesn't Want Cloud Run:**
- Stay with current broken state
- Wait for potential Render credit/sponsorship
- Consider paid Render tier ($7/month)
