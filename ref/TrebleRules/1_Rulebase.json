{
  "meta": {
    "engine_version": "3.2",
    "system": "B-System Chromatic Button Accordion",
    "methodology": "Dmitriev Positional Method",
    "description": "Finalized rulebase with explicit geometric definitions and computational triggers."
  },
  "rules": [
    {
      "id": "H1_LEGATO_NO_REPEAT",
      "description": "In legato articulation, strictly forbid using the same finger for two consecutive distinct notes.",
      "layer": "H1",
      "priority": 1,
      "when": {
        "articulation": "legato",
        "context": "consecutive_notes",
        "is_same_note": false
      },
      "effect": {
        "type": "hard_constraint",
        "constraint": "forbid_same_finger",
        "cost_if_violated": 9999
      }
    },
    {
      "id": "H1_POLY_LOCKED_FINGER",
      "description": "A finger currently holding a sustained note cannot be used for a new note.",
      "layer": "H1",
      "priority": 1,
      "when": {
        "context": "polyphony",
        "finger_status": "locked_in_duration"
      },
      "effect": {
        "type": "hard_constraint",
        "constraint": "finger_unavailable",
        "cost_if_violated": 9999
      }
    },
    {
      "id": "H2_GEOMETRIC_GRIP_COMPACTNESS",
      "description": "Optimize chord fingering based on the sum of Euclidean distances between each finger's center and its assigned target button.",
      "layer": "H2",
      "priority": 2,
      "when": {
        "context": "chord",
        "has_multiple_notes": true
      },
      "effect": {
        "type": "soft_cost",
        "metric": "physical_reach_strain",
        "formula": "sum_of_euclidean_distances_finger_center_to_button"
      }
    },
    {
      "id": "H2_AVOID_AWKWARD_CROSSINGS",
      "description": "Penalize geometric inversions where a lower-indexed finger plays a button geometrically higher/outer than a higher-indexed finger (e.g. finger 3 crossing over 4).",
      "layer": "H2",
      "priority": 2,
      "when": {
        "context": "chord_or_interval",
        "pattern": "geometric_inversion",
        "definition": "finger_index_order_mismatch_with_button_geometric_order"
      },
      "effect": {
        "type": "soft_cost",
        "metric": "anatomical_strain",
        "cost": 50
      }
    },
    {
      "id": "H3_EXTREME_ROW_STABILITY",
      "description": "Penalize usage of outer rows (1 and 5) specifically when hand stability is low (large jumps or high velocity).",
      "layer": "H3",
      "priority": 3,
      "when": {
        "finger_on_row": [
          1,
          5
        ],
        "context_stability": "low"
      },
      "effect": {
        "type": "soft_cost",
        "metric": "positional_instability",
        "cost": 10
      }
    },
    {
      "id": "H3_BELLOWS_SHIFT_ASSIST",
      "description": "Bellows reversal reduces the penalty for position shifts (lateral movement) by 70%.",
      "layer": "H3",
      "priority": 3,
      "when": {
        "event": "bellows_reverse",
        "action": "position_shift"
      },
      "effect": {
        "type": "transform",
        "operation": "scale_shift_cost",
        "factor": 0.3
      }
    },
    {
      "id": "H3_STACCATO_FINGER_HOP",
      "description": "In staccato, allow the same finger to play distinct consecutive notes (hopping), but apply a cost for distance traveled.",
      "layer": "H3",
      "priority": 3,
      "when": {
        "articulation": "staccato",
        "context": "consecutive_notes",
        "is_same_finger": true,
        "is_same_note": false
      },
      "effect": {
        "type": "soft_cost",
        "metric": "hop_distance_penalty",
        "formula": "euclidean_distance * 2"
      }
    },
    {
      "id": "H4_CENTRAL_PIVOT_SHIFT",
      "description": "For large positional shifts, prefer pivoting on central fingers (2, 3) rather than thumb or pinky.",
      "layer": "H4",
      "priority": 4,
      "when": {
        "action": "position_shift",
        "interval_size": "large"
      },
      "effect": {
        "type": "soft_cost",
        "metric": "weak_pivot_penalty",
        "cost_map": {
          "2": 0,
          "3": 0,
          "1": 5,
          "4": 3,
          "5": 8
        }
      }
    },
    {
      "id": "H5_SUBSTITUTION_ADJACENT",
      "description": "Allow substitution on held notes where the finger index delta is exactly 1 (e.g., 2->1, 3->4).",
      "layer": "H5",
      "priority": 5,
      "when": {
        "context": "sustained_note",
        "finger_delta_abs": 1
      },
      "effect": {
        "type": "transform",
        "operation": "inject_substitution_node",
        "cost_modifier": 1
      }
    },
    {
      "id": "H5_SUBSTITUTION_CROSS_HAND",
      "description": "Penalize substitutions where finger index delta is >= 3 (e.g., 1->4, 1->5), representing a cross-hand movement.",
      "layer": "H5",
      "priority": 5,
      "when": {
        "context": "sustained_note",
        "finger_delta_abs": {
          "min": 3
        }
      },
      "effect": {
        "type": "soft_cost",
        "metric": "awkward_substitution",
        "cost": 20
      }
    }
  ]
}